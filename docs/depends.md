# Зависимости библиотеки Colorer

## Библиотеки
### Регулярные выражения
Работа библиотеки основана на проверке соответствия строк исходного файла шаблонам из конфигурационных файлов.
В шаблонах используются регулярные выражения с [расширенным синтаксисом](https://colorer.sourceforge.net/hrc-ref/index.html#hrcre).
Благодаря чему удается обрабатывать блоки текста со стартовым и конечным выражением.

Для обеспечения работы расширенного синтаксиса регулярных выражений был написан свой класс **CRegExp**.
Заменить свою реализацию на что-то более распространенное, типа pcre, пока видится не реальным.
Это потребует делать надстройки над стандартными регулярными выражениями, что выльется не в меньший по объему и сложности код.

*Если честно, то сейчас не хватает мозгов осознать CRegExp.*

### Строки и unicode
Следствием использования своего класса для работы с регулярными выражениями, стала необходимость уметь работать с кодировками текста и свойствами символов.
Т.е. нужно уметь отличать пробельные символы от цифр, или заглавные буквы от строчных. Эти свойства задаются в регулярных выражениях.
Добавим сюда желание работать с текстами на разных языках, просто работать со строками (сравнение, преобразование), и 
быть кросс-платформенным.

На текущий момент всё это проще всего обеспечить с помощью библиотеки **[ICU](https://icu.unicode.org)**. В библиотеке всегда
поддерживается актуальная версия Unicode. Есть все инструменты для работы с символами и их свойствами.

Ранее ([последний commit](https://github.com/colorer/Colorer-library/tree/b4bd3cbc5babb70fffc5a7e523af0311e493b4b5)) использовалась своя реализация строк, работа с
Unicode, свойствами символов и кодировками. [Скрипт разбора](https://github.com/colorer/Colorer-library/blob/b4bd3cbc5babb70fffc5a7e523af0311e493b4b5/src/colorer/unicode/x_tables_generator.pl) Unicode стандарта версии 3.2, и 
преобразование его в код, на текущий момент не рабочий: генерирует код, отличающийся от текущего. Осознать что он делает - не тривиальная задача. Погрузится в свойства Unicode, изучить Perl - жуть.
А после этого еще и поддерживать набор классов вокруг этого кода, где многое выглядит как магия, опять же основанная на свойствах Unicode.

ICU всё же не плох.

### XML
Все настройки (схемы) Colorer хранятся в xml виде. При этом используется xml с external entities. Это позволяет использовать более простые xml файлы,
перенося часть текста/логики во внешние файлы, или ссылаться внутри xml на ранее объявленные сущности. Так же обеспечивается доступ внешним 
файлам внутри архивов (ниже). 

На текущий момент для работы с xml используется библиотека **[Xerces-c](http://xerces.apache.org/)**. Она покрывает все задачи, да и альтернатив [почти нет](https://stackoverflow.com/questions/9387610/what-xml-parser-should-i-use-in-c).

Ранее использовалась своя реализация классов работы с xml. Но она обеспечивала минимально необходимый функционал, и основывалась на старых строках.

### Архивы
Схемы Colorer (hrc) состоят из нескольких сотен файлов. Работать с таким количеством файлов не удобно. Если их упаковать в архив, то уже куда
приятнее с ними работать, распространять.

В качестве типа архива используется zip, а библиотека для работы с ним - **[zlib](https://zlib.net)**.

### Логирование
Для логирования используется **[spdlog](https://github.com/gabime/spdlog)**, одна из лучших реализаций на текущий момент. Она же,
в свою очередь, зависит от **[fmt](https://github.com/fmtlib/fmt)**.

### Тестирование
Для тестирования используется **[Catch2](https://github.com/catchorg/Catch2)**.

## Сборка под Windows
Для сборки библиотеки под Windows, в том числе для FarManager, получаем список зависимостей:
- icu
- xerces-c
- spdlog
- fmt
- zlib

Сборка идет с помощью vcpkg, что сильно её упрощает. Но в то же время сборка достаточно медленная, т.к. ICU и Xerces-c зависят от msys платформы. 
И очень чувствительны к смене версий компилятора и зависимостей в окружении.
Так же есть отдельные заморочки с ICU, чтобы обеспечить сборку только кода для Unicode, без добавления данных по кодировкам, и т.п..

На выходе получаем один бинарный файл без зависимостей.

## Сборка под Linux
Для сборки библиотеки под Linux, получаем список зависимостей:
- icu
- xerces-c
- spdlog
- fmt
- zlib

Для упрощения сборки отключено по умолчанию использование vcpkg. Все зависимости должны быть установлены через системные пакеты.
Это имеет как плюсы, так и минусы:
* выполняем правила работы с linux, используя обще библиотеки, без статической сборки
* ускоряем сборку
* обеспечиваем более быструю сборку, и возможность ставиться на любые системы
* сильно зависим от наличия библиотек под платформу, так и от версии этих библиотек.

### far2l
В far2l используется версия Colorer до перехода на ICU. Список зависимостей:
- xerces-c
- spdlog
- fmt

Поддержка архивов отключена полностью (так удобно? или опять зависимости?). 
Логирование через spdlog опциональное.
Т.е. фактически зависимость одна - xerces-c. Что, порой, вызывает проблемы для использования на некоторых платформах. Т.к. xerces-c не входит 
в список пакетов по умолчанию.

Так же far2l несет ограничение на использование c++ не выше 11 версии.